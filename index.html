<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة مركز صلة التدريبي الدولي - لوحة تحكم المشرفين</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Google Fonts for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0d6efd;
            --light-primary: #f0f5ff;
            --background-color: #f4f7fc;
            --card-bg: #ffffff;
            --text-color: #4a5568;
            --heading-color: #2d3748;
            --border-color: #e2e8f0;
            --danger-color: #dc3545;
        }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .main-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        .app-header {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 1rem;
        }
        .nav-tabs .nav-link {
             color: var(--text-color);
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            border-radius: 8px 8px 0 0;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link:hover{
            border-bottom-color: var(--border-color);
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--light-primary);
            border-color: var(--border-color) var(--border-color) var(--light-primary);
            border-bottom: 3px solid var(--primary-color);
        }
        .panel-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        @media (min-width: 768px) {
            .panel-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        .result-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.5rem;
            background-color: #fcfdff;
            position: relative;
        }
        .card-actions {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        .card-actions .btn {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .modal-header {
            background-color: var(--primary-color);
            color: white;
        }
        .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .form-section-title {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        .loader { text-align: center; padding: 2rem; }
    </style>
</head>
<body>

    <div class="container main-container">
        <header class="text-center mb-4 app-header">
            <h1 class="display-5 fw-bold">لوحة تحكم المشرفين</h1>
            <p class="h5 text-muted">مركز صلة التدريبي الدولي</p>
        </header>

        <main>
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-panel" type="button"><i class="fas fa-chart-line me-2"></i>الملخصات</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="trainees-tab" data-bs-toggle="tab" data-bs-target="#trainees-panel" type="button"><i class="fas fa-user-graduate me-2"></i>المتدربين</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="trainers-tab" data-bs-toggle="tab" data-bs-target="#trainers-panel" type="button"><i class="fas fa-chalkboard-teacher me-2"></i>المدربين</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule-panel" type="button"><i class="fas fa-calendar-alt me-2"></i>الجدولة</button></li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content pt-4" id="myTabContent">
                
                <!-- Summary Panel -->
                <div class="tab-pane fade show active p-3" id="summary-panel" role="tabpanel">
                    <h4 class="mb-4">ملخص الأداء العام</h4>
                    <div id="summary-content" class="row"></div>
                </div>

                <!-- Trainees Panel -->
                <div class="tab-pane fade p-3" id="trainees-panel" role="tabpanel">
                    <div class="panel-header">
                        <h4 class="m-0">قاعدة بيانات المتدربين</h4>
                        <button id="addTraineeBtn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>إضافة متدرب جديد</button>
                    </div>
                    <div class="input-group mb-4">
                        <input type="text" class="form-control" id="trainee-search-input" placeholder="أدخل اسم المتدرب للبحث...">
                        <button class="btn btn-outline-primary" type="button" id="trainee-search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="trainee-results" class="mt-4"></div>
                </div>

                <!-- Trainers Panel -->
                <div class="tab-pane fade p-3" id="trainers-panel" role="tabpanel">
                    <div class="panel-header">
                        <h4 class="m-0">قاعدة بيانات المدربين</h4>
                        <button id="addTrainerBtn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>إضافة مدرب جديد</button>
                    </div>
                    <div class="input-group mb-4">
                        <input type="text" class="form-control" id="trainer-search-input" placeholder="أدخل اسم المدرب للبحث...">
                        <button class="btn btn-outline-primary" type="button" id="trainer-search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="trainer-results" class="mt-4"></div>
                </div>

                <!-- Schedule Panel -->
                <div class="tab-pane fade p-3" id="schedule-panel" role="tabpanel">
                    <div class="panel-header">
                        <h4 class="m-0">جدول مواعيد الكورسات</h4>
                        <button id="addScheduleBtn" class="btn btn-primary"><i class="fas fa-plus me-2"></i>إضافة موعد جديد</button>
                    </div>
                    <div id="schedule-results" class="mt-4"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (Add, Edit, Confirm) -->
    <!-- Add/Edit Trainee Modal -->
    <div class="modal fade" id="traineeModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><form id="traineeForm"><input type="hidden" name="id"><div class="modal-header"><h5 class="modal-title" id="traineeModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 class="form-section-title">بيانات المتدرب</h6><div class="row g-3"><div class="col-md-6"><label class="form-label">الأسم الثلاثي</label><input type="text" name="full_name" class="form-control" required></div><div class="col-md-6"><label class="form-label">رقم الهاتف</label><input type="text" name="phone" class="form-control"></div><div class="col-md-6"><label class="form-label">السكن</label><input type="text" name="address" class="form-control"></div><div class="col-md-6"><label class="form-label">الرقم الوطني</label><input type="text" name="national_id" class="form-control"></div><div class="col-md-6"><label class="form-label">التولد</label><input type="date" name="dob" class="form-control"></div><div class="col-md-6"><label class="form-label">أسم الأم</label><input type="text" name="mother_name" class="form-control"></div><div class="col-12"><label class="form-label">التحصيل العلمي</label><input type="text" name="education" class="form-control"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary">حفظ</button></div></form></div></div></div>
    <!-- Add/Edit Trainer Modal -->
    <div class="modal fade" id="trainerModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><form id="trainerForm"><input type="hidden" name="id"><div class="modal-header"><h5 class="modal-title" id="trainerModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 class="form-section-title">بيانات المدرب</h6><div class="row g-3"><div class="col-md-6"><label class="form-label">الأسم الثلاثي</label><input type="text" name="full_name" class="form-control" required></div><div class="col-md-6"><label class="form-label">رقم الهاتف</label><input type="text" name="phone" class="form-control"></div><div class="col-12"><label class="form-label">السكن</label><input type="text" name="address" class="form-control"></div><div class="col-md-4"><label class="form-label">الرقم الوطني</label><input type="text" name="national_id" class="form-control"></div><div class="col-md-4"><label class="form-label">التولد</label><input type="date" name="dob" class="form-control"></div><div class="col-md-4"><label class="form-label">أسم الأم</label><input type="text" name="mother_name" class="form-control"></div><div class="col-md-6"><label class="form-label">التحصيل العلمي</label><input type="text" name="education" class="form-control"></div><div class="col-md-6"><label class="form-label">الاختصاص التدريبي</label><input type="text" name="specialty" class="form-control"></div><div class="col-12"><label class="form-label">رفع السيرة الذاتية (PDF)</label><input type="file" name="cv_file" class="form-control" accept=".pdf"><small id="currentCv" class="form-text text-muted"></small></div></div><h6 class="form-section-title">تفاصيل التعاقد</h6><div class="row g-3"><div class="col-md-6"><label class="form-label">تاريخ التعاقد</label><input type="date" name="contract_start_date" class="form-control"></div><div class="col-md-6"><label class="form-label">تاريخ انتهاء العقد</label><input type="date" name="contract_end_date" class="form-control"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary">حفظ</button></div></form></div></div></div>
    <!-- Add/Edit Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><form id="scheduleForm"><input type="hidden" name="id"><div class="modal-header"><h5 class="modal-title" id="scheduleModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row g-3"><div class="col-12"><label class="form-label">اسم الكورس</label><select name="course_id" id="course-select-in-modal" class="form-select" required></select></div><div class="col-12"><label class="form-label">اسم المدرب</label><select name="trainer_id" id="trainer-select-in-modal" class="form-select" required></select></div><div class="col-md-6"><label class="form-label">اسم القاعة</label><input type="text" name="hall_name" class="form-control"></div><div class="col-md-6"><label class="form-label">عدد المتدربين</label><input type="number" name="trainee_count" class="form-control"></div><div class="col-md-6"><label class="form-label">تاريخ البدء</label><input type="date" name="start_date" class="form-control"></div><div class="col-md-6"><label class="form-label">تاريخ الانتهاء</label><input type="date" name="end_date" class="form-control"></div><div class="col-md-6"><label class="form-label">وقت البدء</label><input type="time" name="start_time" class="form-control"></div><div class="col-md-6"><label class="form-label">وقت الانتهاء</label><input type="time" name="end_time" class="form-control"></div><div class="col-12"><label class="form-label">أيام الكورس</label><input type="text" name="course_days" class="form-control" placeholder="الأحد - الثلاثاء - الخميس"></div><div class="col-12"><label class="form-label">متقدمون للبورد الألماني (افصل بفاصلة)</label><input type="text" name="german_board_applicants" class="form-control"></div><div class="col-12"><label class="form-label">خطة المسار</label><textarea name="course_plan" class="form-control" rows="3"></textarea></div><div class="col-12"><label class="form-label">المواد المطلوبة</label><textarea name="required_materials" class="form-control" rows="2"></textarea></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button><button type="submit" class="btn btn-primary">حفظ</button></div></form></div></div></div>
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">تأكيد الحذف</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p id="confirmModalText"></p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-danger" id="confirmDeleteBtn">حذف</button></div></div></div></div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // =================================================================================
        // !! هام جداً: قم باستبدال القيم التالية بالبيانات الخاصة بمشروعك على Supabase !!
        // =================================================================================
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // <-- الصق عنوان URL هنا
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY'; // <-- الصق مفتاح anon public هنا
        // =================================================================================
        
        // Check for placeholder credentials before initializing
        if (SUPABASE_URL.includes('YOUR_SUPABASE_URL') || SUPABASE_KEY.includes('YOUR_SUPABASE_ANON_KEY')) {
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.style.display = 'none';
            }
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger text-center mt-4';
            errorDiv.innerHTML = `
                <h4><i class="fas fa-exclamation-triangle me-2"></i>خطأ في الإعداد!</h4>
                <p>يرجى فتح ملف <code>index.html</code> وتحديث قيم <code>SUPABASE_URL</code> و <code>SUPABASE_KEY</code> بالبيانات الصحيحة من مشروعك على Supabase.</p>
                <p>بدون هذه البيانات، لا يمكن للتطبيق الاتصال بقاعدة البيانات.</p>
            `;
            document.querySelector('.main-container').appendChild(errorDiv);
            // Stop the script by throwing an error
            throw new Error("Supabase credentials are not set. Please update them in index.html.");
        }


        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Utility Functions ---
        const showLoader = (containerId) => {
            document.getElementById(containerId).innerHTML = `<div class="loader"><div class="spinner-border text-primary" role="status"></div></div>`;
        };
        
        let deleteFunction = null; // Store the delete function to be called on confirmation
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        function confirmDeletion(callback, message) {
            document.getElementById('confirmModalText').textContent = message;
            deleteFunction = callback;
            confirmModal.show();
        }
        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteFunction) {
                deleteFunction();
            }
            confirmModal.hide();
        });

        // ================================================================================
        //                                      TRAINERS
        // ================================================================================

        async function fetchTrainers(searchTerm = '') {
            showLoader('trainer-results');
            let query = supabaseClient.from('trainers').select('*').order('full_name');
            if (searchTerm) {
                query = query.ilike('full_name', `%${searchTerm}%`);
            }
            const { data, error } = await query;
            if (error) {
                console.error('Error fetching trainers:', error);
                document.getElementById('trainer-results').innerHTML = `<div class="alert alert-danger">خطأ في جلب بيانات المدربين.</div>`;
            } else {
                displayTrainers(data);
            }
        }

        function displayTrainers(trainers) {
            const container = document.getElementById('trainer-results');
            if (!trainers || trainers.length === 0) {
                container.innerHTML = `<div class="alert alert-info">لا يوجد مدربين بهذه المواصفات.</div>`; return;
            }
            container.innerHTML = trainers.map(trainer => `
                <div class="result-card mb-3">
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="openTrainerModal(true, '${trainer.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteTrainer('${trainer.id}', '${trainer.full_name}')"><i class="fas fa-trash"></i></button>
                    </div>
                    <h5><i class="fas fa-user-tie me-2"></i>${trainer.full_name}</h5>
                    <p><strong>الهاتف:</strong> ${trainer.phone || 'غير متوفر'}</p>
                    <p><strong>الاختصاص:</strong> ${trainer.specialty || 'غير متوفر'}</p>
                    <p><strong>السيرة الذاتية:</strong> ${trainer.cv_url ? `<a href="${trainer.cv_url}" target="_blank" class="text-decoration-none">عرض الملف <i class="fas fa-external-link-alt ms-1"></i></a>` : 'لم يتم الرفع'}</p>
                </div>
            `).join('');
        }
        
        const trainerModal = new bootstrap.Modal(document.getElementById('trainerModal'));
        async function openTrainerModal(isEdit = false, id = null) {
            const form = document.getElementById('trainerForm');
            form.reset();
            document.getElementById('currentCv').textContent = '';
            form.querySelector('[name="id"]').value = '';

            if (isEdit) {
                document.getElementById('trainerModalTitle').textContent = 'تعديل بيانات المدرب';
                const { data, error } = await supabaseClient.from('trainers').select('*').eq('id', id).single();
                if (error) { console.error('Error fetching trainer for edit:', error); return; }
                
                Object.keys(data).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    // Don't populate file input for security reasons
                    if (input && key !== 'cv_file') {
                        // For date inputs, ensure the format is YYYY-MM-DD
                        if(input.type === 'date' && data[key]) {
                            input.value = new Date(data[key]).toISOString().split('T')[0];
                        } else {
                            input.value = data[key];
                        }
                    }
                });
                if (data.cv_url) {
                    document.getElementById('currentCv').textContent = `الملف الحالي: ${data.cv_url.split('/').pop()}`;
                }
            } else {
                document.getElementById('trainerModalTitle').textContent = 'إضافة مدرب جديد';
            }
            trainerModal.show();
        }
        
        async function handleTrainerFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const trainerData = Object.fromEntries(formData.entries());
            const id = trainerData.id;
            const cvFile = trainerData.cv_file;
            delete trainerData.cv_file;
            delete trainerData.id;

            // Handle empty date fields
            if(trainerData.dob === '') trainerData.dob = null;
            if(trainerData.contract_start_date === '') trainerData.contract_start_date = null;
            if(trainerData.contract_end_date === '') trainerData.contract_end_date = null;

            if (cvFile && cvFile.size > 0) {
                 const filePath = `public/${Date.now()}-${cvFile.name}`;
                const { error: uploadError } = await supabaseClient.storage.from('trainer-cvs').upload(filePath, cvFile);
                if (uploadError) { console.error('Error uploading CV:', uploadError); alert('حدث خطأ أثناء رفع السيرة الذاتية.'); return; }
                const { data: urlData } = supabaseClient.storage.from('trainer-cvs').getPublicUrl(filePath);
                trainerData.cv_url = urlData.publicUrl;
            }

            let response;
            if (id) { // Update
                response = await supabaseClient.from('trainers').update(trainerData).eq('id', id);
            } else { // Insert
                response = await supabaseClient.from('trainers').insert([trainerData]);
            }
            
            if (response.error) {
                console.error('Error saving trainer:', response.error);
                alert('حدث خطأ أثناء حفظ بيانات المدرب.');
            } else {
                alert('تم حفظ البيانات بنجاح!');
                trainerModal.hide();
                fetchTrainers();
            }
        }
        
        function handleDeleteTrainer(id, name) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('trainers').delete().eq('id', id);
                if (error) { console.error('Error deleting trainer:', error); alert('خطأ في حذف المدرب.'); } 
                else { alert('تم حذف المدرب.'); fetchTrainers(); }
            }, `هل أنت متأكد من حذف المدرب "${name}"؟`);
        }

        // ================================================================================
        //                                      TRAINEES
        // ================================================================================
        
        async function fetchTrainees(searchTerm = '') {
            showLoader('trainee-results');
            let query = supabaseClient.from('trainees').select('*').order('full_name');
            if (searchTerm) {
                query = query.ilike('full_name', `%${searchTerm}%`);
            }
            const { data, error } = await query;
            if (error) {
                console.error('Error fetching trainees:', error);
                document.getElementById('trainee-results').innerHTML = `<div class="alert alert-danger">خطأ في جلب بيانات المتدربين.</div>`;
            } else {
                displayTrainees(data);
            }
        }

        function displayTrainees(trainees) {
            const container = document.getElementById('trainee-results');
            if (!trainees || trainees.length === 0) {
                container.innerHTML = `<div class="alert alert-info">لا يوجد متدربين بهذه المواصفات.</div>`; return;
            }
            container.innerHTML = trainees.map(trainee => `
                <div class="result-card mb-3">
                     <div class="card-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="openTraineeModal(true, '${trainee.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteTrainee('${trainee.id}', '${trainee.full_name}')"><i class="fas fa-trash"></i></button>
                    </div>
                    <h5><i class="fas fa-user-graduate me-2"></i>${trainee.full_name}</h5>
                    <p><strong>الهاتف:</strong> ${trainee.phone || 'غير متوفر'}</p>
                    <p><strong>التحصيل العلمي:</strong> ${trainee.education || 'غير متوفر'}</p>
                </div>
            `).join('');
        }
        
        const traineeModal = new bootstrap.Modal(document.getElementById('traineeModal'));
        async function openTraineeModal(isEdit = false, id = null) {
            const form = document.getElementById('traineeForm');
            form.reset();
            form.querySelector('[name="id"]').value = '';
            if (isEdit) {
                document.getElementById('traineeModalTitle').textContent = 'تعديل بيانات المتدرب';
                const { data, error } = await supabaseClient.from('trainees').select('*').eq('id', id).single();
                if (error) { console.error('Error fetching trainee for edit:', error); return; }
                Object.keys(data).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                         if(input.type === 'date' && data[key]) {
                            input.value = new Date(data[key]).toISOString().split('T')[0];
                        } else {
                            input.value = data[key];
                        }
                    }
                });
            } else {
                document.getElementById('traineeModalTitle').textContent = 'إضافة متدرب جديد';
            }
            traineeModal.show();
        }

        async function handleTraineeFormSubmit(event) {
             event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const traineeData = Object.fromEntries(formData.entries());
            const id = traineeData.id;
            delete traineeData.id;

            if(traineeData.dob === '') traineeData.dob = null;

            let response;
            if (id) { // Update
                response = await supabaseClient.from('trainees').update(traineeData).eq('id', id);
            } else { // Insert
                response = await supabaseClient.from('trainees').insert([traineeData]);
            }
            
            if (response.error) {
                console.error('Error saving trainee:', response.error);
                alert('حدث خطأ أثناء حفظ بيانات المتدرب.');
            } else {
                alert('تم حفظ البيانات بنجاح!');
                traineeModal.hide();
                fetchTrainees();
                fetchSummaryData(); // Update summary
            }
        }
        
        function handleDeleteTrainee(id, name) {
             confirmDeletion(async () => {
                const { error } = await supabaseClient.from('trainees').delete().eq('id', id);
                if (error) { console.error('Error deleting trainee:', error); alert('خطأ في حذف المتدرب.'); } 
                else { alert('تم حذف المتدرب.'); fetchTrainees(); fetchSummaryData(); }
            }, `هل أنت متأكد من حذف المتدرب "${name}"؟`);
        }

        // ================================================================================
        //                                      SCHEDULES
        // ================================================================================
        
        async function fetchSchedules() {
            showLoader('schedule-results');
            const { data, error } = await supabaseClient.from('schedules').select(`*, courses ( name ), trainers ( full_name )`).order('start_date');
            if (error) {
                console.error('Error fetching schedules:', error);
                document.getElementById('schedule-results').innerHTML = `<div class="alert alert-danger">خطأ في جلب بيانات الجدولة.</div>`;
            } else {
                displaySchedules(data);
            }
        }
        
        function displaySchedules(schedules) {
            const container = document.getElementById('schedule-results');
             if (!schedules || schedules.length === 0) {
                container.innerHTML = `<div class="alert alert-info">لا توجد مواعيد مجدولة حالياً.</div>`; return;
            }
            container.innerHTML = schedules.map(schedule => `
                <div class="result-card mb-3">
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="openScheduleModal(true, '${schedule.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteSchedule('${schedule.id}', '${schedule.courses ? schedule.courses.name : 'كورس'}')"><i class="fas fa-trash"></i></button>
                    </div>
                    <h5><i class="fas fa-calendar-check me-2"></i>${schedule.courses ? schedule.courses.name : 'كورس محذوف'}</h5>
                    <p><strong>المدرب:</strong> ${schedule.trainers ? schedule.trainers.full_name : 'مدرب محذوف'}</p>
                    <p><strong>القاعة:</strong> ${schedule.hall_name || 'غير محدد'}</p>
                    <p><strong>التاريخ:</strong> من ${schedule.start_date || '?'} إلى ${schedule.end_date || '?'}</p>
                </div>
            `).join('');
        }
        
        const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        async function openScheduleModal(isEdit = false, id = null) {
            const form = document.getElementById('scheduleForm');
            form.reset();
            form.querySelector('[name="id"]').value = '';
            await populateScheduleModalSelects();

            if (isEdit) {
                document.getElementById('scheduleModalTitle').textContent = 'تعديل الموعد';
                const { data, error } = await supabaseClient.from('schedules').select('*').eq('id', id).single();
                if (error) { console.error('Error fetching schedule for edit:', error); return; }
                Object.keys(data).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        if(key === 'german_board_applicants' && Array.isArray(data[key])) {
                            input.value = data[key].join(', ');
                        } else if(input.type === 'date' && data[key]) {
                            input.value = new Date(data[key]).toISOString().split('T')[0];
                        }
                        else {
                            input.value = data[key];
                        }
                    }
                });
            } else {
                document.getElementById('scheduleModalTitle').textContent = 'إضافة موعد جديد';
            }
            scheduleModal.show();
        }

        async function handleScheduleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const scheduleData = Object.fromEntries(formData.entries());
            const id = scheduleData.id;
            delete scheduleData.id;
            
            // Handle empty date/time fields by setting them to null
            if (scheduleData.start_date === '') scheduleData.start_date = null;
            if (scheduleData.end_date === '') scheduleData.end_date = null;
            if (scheduleData.start_time === '') scheduleData.start_time = null;
            if (scheduleData.end_time === '') scheduleData.end_time = null;
            if (scheduleData.trainee_count === '') scheduleData.trainee_count = null;
            
            if (scheduleData.german_board_applicants) {
                scheduleData.german_board_applicants = scheduleData.german_board_applicants.split(',').map(s => s.trim());
            } else { scheduleData.german_board_applicants = []; }

            let response;
            if(id) {
                response = await supabaseClient.from('schedules').update(scheduleData).eq('id', id);
            } else {
                response = await supabaseClient.from('schedules').insert([scheduleData]);
            }
            
             if (response.error) {
                console.error('Error saving schedule:', response.error); alert('حدث خطأ أثناء حفظ الموعد.');
            } else {
                alert('تم حفظ الموعد بنجاح!');
                scheduleModal.hide();
                fetchSchedules();
            }
        }
        
        function handleDeleteSchedule(id, name) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('schedules').delete().eq('id', id);
                if (error) { console.error('Error deleting schedule:', error); alert('خطأ في حذف الموعد.'); } 
                else { alert('تم حذف الموعد.'); fetchSchedules(); }
            }, `هل أنت متأكد من حذف موعد كورس "${name}"؟`);
        }
        
        async function populateScheduleModalSelects() {
            const { data: courses } = await supabaseClient.from('courses').select('id, name');
            const { data: trainers } = await supabaseClient.from('trainers').select('id, full_name');
            if (courses) {
                document.getElementById('course-select-in-modal').innerHTML = courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
            if (trainers) {
                document.getElementById('trainer-select-in-modal').innerHTML = trainers.map(t => `<option value="${t.id}">${t.full_name}</option>`).join('');
            }
        }
        
        // ================================================================================
        //                                      SUMMARY & COURSES
        // ================================================================================
        
        async function fetchSummaryData() {
            showLoader('summary-content');
            const { count, error: countError } = await supabaseClient.from('trainees').select('*', { count: 'exact', head: true });
            const { data: courses, error: coursesError } = await supabaseClient.from('courses').select('*').order('name');

            if(countError || coursesError) {
                 console.error('Error fetching summary:', countError || coursesError);
                 document.getElementById('summary-content').innerHTML = `<div class="alert alert-danger">خطأ في جلب بيانات الملخص.</div>`;
                 return;
            }
            
            document.getElementById('summary-content').innerHTML = `
                <div class="col-lg-5 mb-4">
                    <div class="card text-center h-100 shadow-sm">
                        <div class="card-body p-4 d-flex flex-column justify-content-center">
                            <i class="fas fa-users fa-3x text-primary mb-3"></i>
                            <h5 class="card-title h4">إجمالي الطلاب المسجلين</h5>
                            <p class="display-4 fw-bold m-0">${count || 0}</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7 mb-4">
                     <div class="card h-100 shadow-sm">
                        <div class="card-body p-4">
                            <h5 class="card-title h4 text-center">إدارة الكورسات</h5>
                             <form id="addCourseForm" class="d-flex mt-3 mb-3">
                                <input type="text" name="name" class="form-control me-2" placeholder="اسم الكورس الجديد" required>
                                <button type="submit" class="btn btn-success flex-shrink-0">إضافة</button>
                            </form>
                            <ul id="coursesList" class="list-group list-group-flush">
                                ${courses.length > 0 ? courses.map(c => `<li class="list-group-item d-flex justify-content-between align-items-center">${c.name}<button class="btn btn-sm btn-outline-danger" onclick="handleDeleteCourse('${c.id}', '${c.name}')"><i class="fas fa-trash"></i></button></li>`).join('') : '<li class="list-group-item">لا توجد كورسات مضافة.</li>'}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
             document.getElementById('addCourseForm').addEventListener('submit', handleAddCourse);
        }

        async function handleAddCourse(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const courseName = formData.get('name');

            const { error } = await supabaseClient.from('courses').insert([{ name: courseName }]);
            if (error) { alert(`خطأ: ${error.message}`); } 
            else { alert('تمت إضافة الكورس بنجاح!'); form.reset(); fetchSummaryData();}
        }
        
        function handleDeleteCourse(id, name) {
            confirmDeletion(async () => {
                const { error } = await supabaseClient.from('courses').delete().eq('id', id);
                if (error) { alert('خطأ في حذف الكورس. قد يكون مرتبطاً بجدول زمني.'); console.error(error); } 
                else { alert('تم حذف الكورس.'); fetchSummaryData(); }
            }, `هل أنت متأكد من حذف كورس "${name}"؟ سيتم حذف كل الجداول المرتبطة به.`);
        }

        // --- Event Listeners & Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial data fetch
            fetchSummaryData();
            fetchTrainees();
            fetchTrainers();
            fetchSchedules();

            // Search listeners
            document.getElementById('trainee-search-btn').addEventListener('click', () => fetchTrainees(document.getElementById('trainee-search-input').value));
            document.getElementById('trainer-search-btn').addEventListener('click', () => fetchTrainers(document.getElementById('trainer-search-input').value));
            
            // "Add" buttons listeners
            document.getElementById('addTrainerBtn').addEventListener('click', () => openTrainerModal());
            document.getElementById('addTraineeBtn').addEventListener('click', () => openTraineeModal());
            document.getElementById('addScheduleBtn').addEventListener('click', () => openScheduleModal());

            // Form submission listeners
            document.getElementById('traineeForm').addEventListener('submit', handleTraineeFormSubmit);
            document.getElementById('trainerForm').addEventListener('submit', handleTrainerFormSubmit);
            document.getElementById('scheduleForm').addEventListener('submit', handleScheduleFormSubmit);
        });

    </script>
</body>
</html>
